/*global google root_url static_url console*/function roundNumber(e,t){var n=Math.round(e*Math.pow(10,t))/Math.pow(10,t);return n}function show_error_message(e){var t='<div class="alert alert-block alert-error fade in" id="error-msg"><button type="button" class="close" data-dismiss="alert">&times;</button><h4>Oh No!</h4>'+e+"</div>";$("#error-msg").html(t)}function clear_map(){var e;for(e in heatmaps)heatmaps[e].setMap(null);heatmaps[e]=null}function get_outcome_data(e,t){var n,r=e.split("-"),i=t.split("-"),s=r[0],o=r[1],u=i[0],a=i[1],f=map.getBounds(),l=f.getNorthEast(),c=f.getSouthWest(),h=root_url+"/api/outcomes/?ne="+l.lat()+","+l.lng()+"&sw="+c.lat()+","+c.lng()+"&sy="+s+"&sm="+o+"&ey="+u+"&em="+a;console.log(h);n=[];$.getJSON(h,{},function(e){var t,r,i,s,o,u=e.outcomes;for(t in u){r=roundNumber(u[t].outcome.point.lat,5);i=roundNumber(u[t].outcome.point.lng,5);n.push(new google.maps.LatLng(r,i))}s=new google.maps.MVCArray(n);o=new google.maps.visualization.HeatmapLayer({data:s,opts:{radius:15,visible:!0,opacity:60}});o.setMap(map);heatmaps.push(o);$(".overlay").addClass("hidden")})}function get_food_data(){var e,t=map.getBounds(),n=t.getNorthEast(),r=t.getSouthWest(),i=root_url+"/api/food/?ne="+n.lat()+","+n.lng()+"&sw="+r.lat()+","+r.lng();console.log(i);e=[];$.getJSON(i,{},function(t){var n,r,i,s,o,u,a=t.establishments;for(n in a){r=roundNumber(a[n].Latitude,5);i=roundNumber(a[n].Longitude,5);e.push({location:new google.maps.LatLng(r,i),weight:parseInt(a[n].RatingValue)})}s=new google.maps.MVCArray(e);o=["rgba(248,255,232,1)","rgba(227,245,171,1)","rgba(183,223,45,1)"];u=new google.maps.visualization.HeatmapLayer({data:s,opts:{radius:15,visible:!0,opacity:60,gradient:o}});u.setMap(map);heatmaps.push(u);$(".overlay").addClass("hidden")})}function get_crime_data(e,t){var n,r=e.split("-"),i=t.split("-"),s=r[0],o=r[1],u=i[0],a=i[1],f=map.getBounds(),l=f.getNorthEast(),c=f.getSouthWest(),h=root_url+"/api/crimes/?ne="+l.lat()+","+l.lng()+"&sw="+c.lat()+","+c.lng()+"&sy="+s+"&sm="+o+"&ey="+u+"&em="+a;console.log(h);n=[];$.getJSON(h,{},function(e){var t,r,i,s,o,u=e.crimes;for(t in u){r=roundNumber(u[t].crime.point.lat,5);i=roundNumber(u[t].crime.point.lng,5);n.push(new google.maps.LatLng(r,i))}s=new google.maps.MVCArray(n);o=new google.maps.visualization.HeatmapLayer({data:s,opts:{radius:15,visible:!0,opacity:60}});o.setMap(map);heatmaps.push(o)});$(".overlay").addClass("hidden")}function show_date_error(e){show_error_message(e);$("#from-date-group").addClass("error");$("#to-date-group").addClass("error")}function reset_error_state(){$("#error-msg").html("");$("#from-date-group").removeClass("error");$("#to-date-group").removeClass("error")}function validate(e){var t,n,r,i;$(".overlay").removeClass("hidden");reset_error_state();clear_map();t=$("#from_date").prop("valueAsNumber");n=$("#from_date").prop("value");r=$("#to_date").prop("valueAsNumber");i=$("#to_date").prop("value");if(r<t)show_date_error("Date selection error - Start date must be before end date!");else if(i===""||n==="")show_date_error("Date selection error - No start or end date selected!");else{if($("#crime-data").attr("checked")){console.log("crime-data checked");get_crime_data(n,i)}if($("#outcome-data").attr("checked")){console.log("outcome-data checked");get_outcome_data(n,i)}if($("#food-data").attr("checked")){console.log("food-data checked");get_food_data()}}google.maps.event.addListener(map,"idle",function(){validate($(e))})}function DataMap(e){var t=new google.maps.LatLng(51.481307,-3.1804986);this.map_options={zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(e,this.map_options);navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude)});map.setCenter(t);$(".overlay").addClass("hidden")}var map,heatmaps=[];$(document).ready(function(){var e=new DataMap(document.getElementById("map-canvas"))});